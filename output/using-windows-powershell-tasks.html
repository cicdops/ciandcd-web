<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>
    Using Windows PowerShell tasks - ciandcd</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="http://www.ciandcd.com/theme/css/bootstrap.css" rel="stylesheet" type="text/css"/>
  <link href="http://www.ciandcd.com/theme/css/main.css" rel="stylesheet" type="text/css"/>
  <link href="http://www.ciandcd.com/theme/css/pygment.css" rel="stylesheet" type="text/css"/>
  <link href="http://fonts.googleapis.com/css?family=Chelsea+Market" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" type="text/css" href="http://www.ciandcd.com/theme/tipuesearch/tipuesearch.css" media="screen">
<link href="http://www.ciandcd.com/feeds/rss.xml" rel="alternate" type="application/atom+xml" title="ciandcd RSS" />


  <!--[if lt IE 9]>
    <script src="https://raw.github.com/aFarkas/html5shiv/master/dist/html5shiv.js"></script>
  <![endif]-->
</head>

<!--
bootstrap-itech - a Pelican theme using Bootstrap
-->
<body>

<!-- Header -->
<header>
<div class="container-fluid">
<h1 class="page-header"><a href="http://www.ciandcd.com/index.html">ciandcd </a>
<h4>软件持续集成和持续发布 QQ群：172758282，437085002</h4></h1>
</div>
</header>
<!-- /Header -->

<nav class="navbar navbar-default">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://www.ciandcd.com/index.html"></a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

  <li><a href="http://www.ciandcd.com/index.html">首页</a></li>

  <li class="active"><a href="http://www.ciandcd.com/category/ciandcd.html">ciandcd</a></li>
  <li ><a href="http://www.ciandcd.com/category/devops.html">devops</a></li>
  <li ><a href="http://www.ciandcd.com/category/scm.html">scm</a></li>
  <li ><a href="http://www.ciandcd.com/category/zhong-wen.html">中文</a></li>

  
    <li ><a href="http://www.ciandcd.com/pages/guan-yu.html">关于</a></li>
    <li ><a href="http://www.ciandcd.com/pages/awesome.html">Awesome</a></li>


</ul>
      <form class="navbar-form navbar-left navbar-search" role="search" action="http://www.ciandcd.com/search.html onsubmit="return validateForm(this.elements['q'].value);">
        <div class="form-group search-query">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input">
        </div>
      </form>

      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://www.cnblogs.com/itech">itech</a></li>
        <li><a href="https://github.com/ciandcd">Github</a></li>
      </ul>

    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<!-- Body -->
<section id="body">
<div class="container-fluid">

<!-- Nav bar -->
<!-- /Nav bar -->

<!-- Main block -->
<div class="row">

<!-- Content -->
<div class="col-lg-9">
<article>

From:<a href="http://www.go.cd/2015/06/13/using-windows-powershell-tasks.html">http://www.go.cd/2015/06/13/using-windows-powershell-tasks.html</a><br><br><div><p>Some things to be aware of when using Windows PowerShell tasks.</p>

<h3>Go Agent default installation</h3>

<p>The <a href="http://www.go.cd/documentation/user/current/installation/installing_go_agent.html">default</a> installation of a Go
agent will use a 32-bit JRE unless you indicate otherwise. This JRE is embedded in the Go agent installer.</p>

<p>If you want to use an alternative JRE (must satisfy Go's JRE requirements) after the initial installation, you can alter
the "wrapper.java.command" key's value in the <code>[InstallDirectory]\config\wrapper-agent.conf</code> file  to point to a
different JRE. You will then need to restart the Go agent service to start using the alternative JRE.</p>

<p>The <code>[InstallDirectory]</code> refers to the Go agents installation directory which by default is <code>"C:\Program Files (x86)\Go Agent"</code>.</p>

<h3>Pre-requisites for running PowerShell task commands</h3>

<ul>
<li>You can only run on Windows based agents</li>
<li>You should tag the agents if your are also using linux agents<br></li>
<li>You probably want to ensure your agents all have the same version of PowerShell<br></li>
</ul>

<h4>32-bit Go agent</h4>

<p>If you are running a default Go agent installation then you will be running a 32-bit JRE.</p>

<p>The 32-bit JRE will try to run PowerShell tasks in the 32-bit version of PowerShell, even if you give the full path to
the 64-bit PowerShell executable in the task. If you need to execute a PowerShell script then you will need to alter the
execution policy as follows:</p>

<ul>
<li>Open 32-bit version of PowerShell as an administrator: Start -&gt; All Programs -&gt; Accessories -&gt; Windows Powershell -&gt; Windows Powershell (x86) and type:</li>
</ul>
<pre><code class="language-powershell"><p class="c"># Alter execution policy</p>
<p class="nb">set-executionpolicy</p> <p class="n">remotesigned</p> <p class="n">-force</p>  
</code></pre><p>This will allow you to run local scripts on the Windows Go agent box.</p>

<h4>64-bit Go agent</h4>

<p>If you are running a Go agent using a 64-bit JRE, it will run PowerShell tasks in the 64-bit version of PowerShell.</p>

<p>If you need to execute a PowerShell script, then you will need to alter the execution policy as follows:</p>

<ul>
<li>Open 64-bit version of PowerShell as an administrator: Start -&gt; All Programs -&gt; Accessories -&gt; Windows Powershell -&gt;
Windows Powershell and type:</li>
</ul>
<pre><code class="language-powershell"><p class="c"># Alter execution policy</p>
<p class="nb">set-executionpolicy</p> <p class="n">remotesigned</p> <p class="n">-force</p>  
</code></pre><p>This will allow you to run local scripts on the Windows Go agent box.</p>

<h3>PowerShell task commands</h3>

<p>You can configure the task as follows:</p>
<pre><code class="language-text">command: powershell  
arg: .\run.ps1 arg1value  
</code></pre><p>This assumes that the <code>run.ps1</code> script is in the task's working directory.</p>

<p>If you create the <code>run.ps1</code> file with the following content you can see details of the execution context in the console log for the pipeline:</p>
<pre><code class="language-powershell"><p class="k">param</p>
<p class="p">(</p>
    <p class="no">[string]</p> <p class="nv">$arg1</p>
<p class="p">)</p>
<p class="nb">write-host</p> <p class="s2">"Script:            "</p> <p class="nv">$MyInvocation</p><p class="p">.</p><p class="n">MyCommand</p><p class="p">.</p><p class="n">Path</p>
<p class="nb">write-host</p> <p class="s2">"Pid:               "</p> <p class="nv">$pid</p>
<p class="nb">write-host</p> <p class="s2">"Host.Version:      "</p> <p class="nv">$host</p><p class="p">.</p><p class="n">version</p>
<p class="nb">write-host</p> <p class="s2">"Is 64-bit process: "</p> <p class="p">$(</p><p class="no">[Environment]</p><p class="p">::</p><p class="n">Is64BitProcess</p><p class="p">)</p>
<p class="nb">write-host</p> <p class="s2">"Execution policy:  "</p> <p class="p">$(</p><p class="nb">get-executionpolicy</p><p class="p">)</p>
<p class="nb">write-host</p> <p class="s2">"Arg1:              "</p> <p class="nv">$arg1</p>
</code></pre><h3>Propagating failures</h3>

<p>You need to ensure that PowerShell exits with an exit code that is not 0 in the event of a failure, this needs to cater to:</p>

<ul>
<li>Script errors</li>
<li>External process calls that indicate failure</li>
</ul>

<p>You will need to decide how to handle these failures and if they should indicate the PowerShell task has been successful
or not. This may mean that some script errors and external process calls failing is okay in your context.</p>

<p>The following script demonstrates a strategy I use where I exit with a non zero code if any script error was encountered
or an external process call fails:</p>
<pre><code class="language-powershell"><p class="nb">set-strictmode</p> <p class="n">-version</p> <p class="n">latest</p>
<p class="nv">$ErrorActionPreference</p> <p class="p">=</p> <p class="s1">'Stop'</p>

<p class="k">function</p> <p class="n">execute-externaltool</p>
<p class="p">(</p>
    <p class="no">[string]</p> <p class="nv">$context</p><p class="p">,</p>
    <p class="no">[scriptblock]</p> <p class="nv">$actionBlock</p>
<p class="p">)</p>
<p class="p">{</p>
    <p class="c"># This function exists to check the exit code for the external tool called within the script block, so we don't have to do this for each call</p>
    <p class="p">&amp;</p> <p class="nv">$actionBlock</p>
    <p class="k">if</p> <p class="p">(</p><p class="nv">$LastExitCode</p> <p class="o">-gt</p> <p class="n">0</p><p class="p">)</p> <p class="p">{</p> <p class="k">throw</p> <p class="s2">"$context : External tool call failed"</p> <p class="p">}</p>
<p class="p">}</p>


<p class="k">try</p>
<p class="p">{</p>
    <p class="nb">write-host</p> <p class="s2">"Script:            "</p> <p class="nv">$MyInvocation</p><p class="p">.</p><p class="n">MyCommand</p><p class="p">.</p><p class="n">Path</p>
    <p class="nb">write-host</p> <p class="s2">"Pid:               "</p> <p class="nv">$pid</p>
    <p class="nb">write-host</p> <p class="s2">"Host.Version:      "</p> <p class="nv">$host</p><p class="p">.</p><p class="n">version</p>
    <p class="nb">write-host</p> <p class="s2">"Execution policy:  "</p> <p class="p">$(</p><p class="nb">get-executionpolicy</p><p class="p">)</p>

    <p class="c"># Query a service that does not exist, sc.exe will return with a non 0 exit code</p>
    <p class="n">execute-externaltool</p> <p class="s2">"Query a non existent service, will return with exit code != 0"</p> <p class="p">{</p> <p class="n">c</p><p class="err">:</p><p class="p">\</p><p class="n">windows</p><p class="p">\</p><p class="n">system32</p><p class="p">\</p><p class="n">sc</p><p class="p">.</p><p class="n">exe</p> <p class="n">query</p> <p class="n">service_does_not_exist</p> <p class="p">}</p> 
<p class="p">}</p>
<p class="k">catch</p>
<p class="p">{</p>
    <p class="nb">write-host</p> <p class="s2">"$pid : Error caught - $_"</p>
    <p class="k">if</p> <p class="p">($?</p> <p class="o">-and</p> <p class="p">(</p><p class="nb">test-path</p> <p class="n">variable</p><p class="err">:</p><p class="n">LastExitCode</p><p class="p">)</p> <p class="o">-and</p> <p class="p">(</p><p class="nv">$LastExitCode</p> <p class="o">-gt</p> <p class="n">0</p><p class="p">))</p> <p class="p">{</p> <p class="n">exit</p> <p class="nv">$LastExitCode</p> <p class="p">}</p>
    <p class="k">else</p> <p class="p">{</p> <p class="n">exit</p> <p class="n">1</p> <p class="p">}</p>
<p class="p">}</p>
</code></pre><ul>
<li>This script uses a try catch block to handle all errors

<ul>
<li>The $? and $LastExitCode caters to both script and external process calls</li>
<li>We fall back on an exit code of 1 if we do not have an external process exit code</li>
</ul></li>
<li>This script uses an execute-externaltool function which takes a script block argument

<ul>
<li>The script will invoke the script block</li>
<li>It will then check for a non zero exit code (Assumes the script block just calls an external process), if so it will throw an exception.</li>
</ul></li>
</ul>

<h3>See also</h3>

<p><a href="https://technet.microsoft.com/en-us/library/hh849812.aspx">PowerShell execution policy</a><br>
<a href="https://blog.netspi.com/15-ways-to-bypass-the-powershell-execution-policy/">Bypassing PowerShell execution policy</a><br>
<a href="https://codelucidate.wordpress.com/powershell/change-execution-policy-in-the-registry/">Setting execution policy directly in the registry</a><br>
<a href="https://github.com/manojlds/gocd-powershell-runner">Go PowerShell runner plugin</a> - I believe it can only be configured on Windows based Go servers  </p>

<h3>About the author</h3>

<p>This is a guest post by Pat Mc Grath. You can find Pat <a href="https://github.com/pmcgrath">on GitHub</a>.</p>

</div>

<p class="info">
<h4>
Posted Sat 27 June 2015
 by <a class="url fn" href="http://www.ciandcd.com/author/itech001.html">itech001</a>
in <a href="http://www.ciandcd.com/category/ciandcd.html">ciandcd</a>
</h4></p>

</article>
</div>
<!-- /Content -->

<!-- Side bar -->
<nav class="col-lg-3">

<h2>分类</h2>
<ul class="nav nav-pills nav-stacked">
  <li class="active"><a href="http://www.ciandcd.com/category/ciandcd.html">ciandcd</a></li>
  <li ><a href="http://www.ciandcd.com/category/devops.html">devops</a></li>
  <li ><a href="http://www.ciandcd.com/category/scm.html">scm</a></li>
  <li ><a href="http://www.ciandcd.com/category/zhong-wen.html">中文</a></li>
</ul>

<ul class="tagcloud">
</ul>

<h2>链接</h2>
<ul class="nav nav-pills nav-stacked">
  <li><a href="http://www.cnblogs.com/itech/">itech</a></li>
</ul>

<h2>联系</h2>
<ul class="nav nav-pills nav-stacked">
  <li><a href="http://www.ciandcd.com/feeds/rss.xml" type="application/rss+xml" rel="alternate">Site Feed</a></li>
  <li><a href="https://github.com/ciandcd">Github</a></li>
</ul>

</nav>
<!-- /Side bar -->

</div>
<!-- /Main block -->

<!-- Footer -->
<div class="row"><div class="col-lg-12">
<footer><small>
Built using <a href="http://pelican.notmyidea.org/">Pelican</a> and
<a href="http://twitter.github.com/bootstrap">Bootstrap</a>.
</small></footer>
</div></div>
<!-- /Footer -->

</div></section>
<!-- /Body -->

<script src="http://www.ciandcd.com/theme/js/jquery.js"></script>
<script src="http://www.ciandcd.com/theme/js/bootstrap.js"></script>


</body>
</html>